<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>EP2C Mock — Viewer</title>
  <link rel="stylesheet" href="/static/css/styles.css">

  <!-- highlight.js with a GitHub-like dark theme + line numbers plugin -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.13.0/highlightjs-line-numbers.min.js"></script>

  <!-- Safely inject the files list as JSON -->
  <script id="files-data" type="application/json">
    {{ files|tojson|safe }}
  </script>
</head>
<body>
  <header class="topbar">
    <div><strong>EP2C Mock</strong> — Language: {{ language }} • Complexity: {{ complexity }}</div>
    <a href="/" class="link">Start over</a>
  </header>

  <div class="layout">
    <!-- VS Code-like Explorer -->
    <aside class="sidebar">
      <div class="explorer-header">EXPLORER</div>
      <div class="workspace-title">EP2C Mock</div>
      <ul id="fileTree" class="vscode-tree"></ul>
    </aside>

    <!-- Code viewer with GitHub-like chrome -->
    <main class="code-pane">
      <div class="code-toolbar">
        <div class="file-chip" id="openFileName">Select a file…</div>
        <div class="toolbar-spacer"></div>
      </div>
      <div class="code-frame">
        <pre><code id="code" class="hljs"></code></pre>
      </div>
    </main>

    <!-- Right: PDF viewer -->
    <aside class="pdf-pane">
      <iframe id="pdfFrame" src="{{ pdf_url }}" title="Uploaded PDF" frameborder="0"></iframe>
    </aside>
  </div>

  <script>
    // Init base HLJS
    hljs.highlightAll();

    // Parse files from the JSON script tag
    const fileList = (() => {
      try {
        return JSON.parse(document.getElementById('files-data').textContent) || [];
      } catch (_) {
        return [];
      }
    })();

    // Build a nested tree from "path" (e.g., utils/data.py)
    function buildTree(list) {
      const root = {};
      for (const f of list) {
        const parts = f.path.split('/');
        let cur = root;
        for (let i = 0; i < parts.length; i++) {
          const part = parts[i];
          const isFile = i === parts.length - 1;
          if (!cur[part]) {
            cur[part] = {
              __children: {},
              __isFile: isFile,
              __url: isFile ? f.url : null,
              __label: part
            };
          }
          if (!isFile) cur = cur[part].__children;
        }
      }
      return root;
    }

    function iconSVG(kind) {
      if (kind === 'folder') {
        return '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M10 4l2 2h8a2 2 0 012 2v1H2V6a2 2 0 012-2h6z"></path><path d="M2 9h22v9a2 2 0 01-2 2H4a2 2 0 01-2-2V9z"></path></svg>';
      }
      return '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M6 2h9l5 5v13a2 2 0 01-2 2H6a2 2 0 01-2-2V4a2 2 0 012-2z"></path></svg>';
    }

    function renderTree(container, tree) {
      const entries = Object.entries(tree).filter(([k]) => !k.startsWith('__'));
      entries.sort((a, b) => {
        const aNode = tree[a[0]];
        const bNode = tree[b[0]];
        const aIsFile = aNode.__isFile === true;
        const bIsFile = bNode.__isFile === true;
        if (aIsFile !== bIsFile) return aIsFile ? 1 : -1;
        return a[0].localeCompare(b[0]);
      });

      for (const [name, node] of entries) {
        const li = document.createElement('li');
        if (node.__isFile) {
          li.className = 'vscode-item file';
          li.innerHTML = `
            <button class="vscode-row" data-url="${node.__url}">
              <span class="twisty placeholder"></span>
              <span class="icon">${iconSVG('file')}</span>
              <span class="label">${name}</span>
            </button>
          `;
        } else {
          li.className = 'vscode-item folder';
          li.innerHTML = `
            <button class="vscode-row" data-toggle="folder">
              <span class="twisty">▸</span>
              <span class="icon">${iconSVG('folder')}</span>
              <span class="label">${name}</span>
            </button>
            <ul class="vscode-children"></ul>
          `;
          const childrenUl = li.querySelector('.vscode-children');
          renderTree(childrenUl, node.__children);
        }
        container.appendChild(li);
      }
    }

    function hydrateTreeInteractions(rootEl) {
      rootEl.querySelectorAll('[data-toggle="folder"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const li = btn.closest('.vscode-item.folder');
          li.classList.toggle('open');
          const twisty = btn.querySelector('.twisty');
          twisty.textContent = li.classList.contains('open') ? '▾' : '▸';
        });
      });

      rootEl.querySelectorAll('.vscode-item.file .vscode-row').forEach(btn => {
        btn.addEventListener('click', async () => {
          const url = btn.dataset.url;
          await loadFile(url);
          rootEl.querySelectorAll('.vscode-row.active').forEach(el => el.classList.remove('active'));
          btn.classList.add('active');
        });
      });
    }

    async function loadFile(url) {
      const res = await fetch(url);
      const text = await res.text();

      const codeEl = document.getElementById('code');
      const nameEl = document.getElementById('openFileName');

      nameEl.textContent = url.split('/').slice(-1)[0];

      codeEl.classList.remove('hljs-ln');
      codeEl.innerHTML = '';
      codeEl.textContent = text;

      hljs.highlightElement(codeEl);
      try { hljs.lineNumbersBlock(codeEl); } catch (e) {}
    }

    // Render the tree and open first file
    const tree = buildTree(fileList);
    const treeRoot = document.getElementById('fileTree');
    renderTree(treeRoot, tree);
    hydrateTreeInteractions(treeRoot);

    const firstFileBtn = treeRoot.querySelector('.vscode-item.file .vscode-row');
    if (firstFileBtn) firstFileBtn.click();
  </script>
</body>
</html>
